rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Les administrateurs ont un accès complet à toutes les données.
    // La fonction helper isAdmin() vérifie si l'UID de l'utilisateur est dans la collection 'admins'.
    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Accès global pour les administrateurs
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // Les utilisateurs peuvent lire et mettre à jour leur propre document.
    match /users/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
    }

    // Tout le monde peut lire la liste des cours et leurs détails.
    match /courses/{courseId} {
      allow read: if true;

      // Règles pour la sous-collection des inscriptions
      match /enrollments/{userId} {
        // Un utilisateur authentifié peut créer sa propre demande d'inscription.
        // Le document doit correspondre à son UID.
        allow create: if request.auth != null && request.auth.uid == userId;

        // Un utilisateur peut lire sa propre inscription pour en connaître le statut.
        // Les admins peuvent lire toutes les inscriptions (règle globale ci-dessus).
        allow read: if request.auth != null && request.auth.uid == userId;

        // Seuls les admins peuvent mettre à jour (approuver/rejeter) ou supprimer (révoquer).
        allow update, delete: if isAdmin();
      }

      // Seuls les admins peuvent écrire dans les autres sous-collections (documents, etc.)
      match /{allother=**} {
        allow write: if isAdmin();
      }
    }

    // La collection des admins ne peut être lue que par d'autres admins (via la règle globale).
    match /admins/{adminId} {
      allow read, write: if isAdmin();
    }
  }
}