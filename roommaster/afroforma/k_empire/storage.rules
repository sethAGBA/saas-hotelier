rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Admins: full access to any file under /courses, regardless of nesting
    match /courses/{allPaths=**} {
      allow read, write: if request.auth != null &&
                         firestore.exists(/databases/(default)/documents/admins/$(request.auth.uid));
    }

    // Les administrateurs peuvent lire et écrire tous les fichiers de cours.
    // On vérifie si l'UID de l'utilisateur existe dans la collection 'admins'.
    match /courses/{courseId}/{allPaths=**} {
      allow read, write: if request.auth != null && 
                         firestore.exists(/databases/(default)/documents/admins/$(request.auth.uid));

      // Les utilisateurs inscrits et approuvés peuvent lire les fichiers du cours.
      // On vérifie si un document avec l'UID de l'utilisateur existe dans la sous-collection
      // des inscriptions du cours et si son statut est 'approved'.
      allow read: if request.auth != null &&
                  firestore.exists(/databases/(default)/documents/courses/$(courseId)/enrollments/$(request.auth.uid)) &&
                  firestore.get(/databases/(default)/documents/courses/$(courseId)/enrollments/$(request.auth.uid)).data.status == 'approved';
    }

    // Permettre aux utilisateurs de lire/écrire dans leurs propres dossiers (si nécessaire).
    match /users/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Pièces jointes des messages: écriture réservée aux administrateurs
    match /messages_attachments/{recipientUid}/{allPaths=**} {
      allow write: if request.auth != null &&
                   firestore.exists(/databases/(default)/documents/admins/$(request.auth.uid));
      // Lectures via URL signée ne passent pas par les règles Storage.
    }
  }
}
